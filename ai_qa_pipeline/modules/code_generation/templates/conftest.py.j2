"""
Pytest Configuration for Generated Tests

Auto-generated conftest.py for {{ framework }}
Base URL: {{ base_url }}
Browser: {{ browser }}
Headless: {{ headless }}
"""

import pytest
from playwright.sync_api import sync_playwright, Browser, BrowserContext, Page


@pytest.fixture(scope="session")
def browser_type_launch_args():
    """Browser launch arguments"""
    return {
        "headless": {{ headless }},
        "args": [
            "--no-sandbox",
            "--disable-dev-shm-usage",
        ]
    }


@pytest.fixture(scope="session")
def browser_context_args():
    """Browser context configuration"""
    return {
        "viewport": {"width": 1920, "height": 1080},
        "ignore_https_errors": True,
        "record_video_dir": "videos/" if not {{ headless }} else None,
        "record_video_size": {"width": 1920, "height": 1080}
    }


@pytest.fixture(scope="function")
def page(browser: Browser, browser_context_args: dict):
    """
    Create a new page for each test

    Args:
        browser: Playwright browser instance
        browser_context_args: Context configuration

    Yields:
        Page: New page instance
    """
    context = browser.new_context(**browser_context_args)
    page = context.new_page()

    # Set default timeout
    page.set_default_timeout(30000)

    # Set default navigation timeout
    page.set_default_navigation_timeout(30000)

    yield page

    # Cleanup
    page.close()
    context.close()


@pytest.fixture(scope="function")
def base_url():
    """Base URL for tests"""
    return "{{ base_url }}"


# Hooks for screenshots on failure
@pytest.hookimpl(tryfirst=True, hookwrapper=True)
def pytest_runtest_makereport(item, call):
    """Take screenshot on test failure"""
    outcome = yield
    rep = outcome.get_result()

    if rep.when == "call" and rep.failed:
        # Get page from test
        if "page" in item.funcargs:
            page = item.funcargs["page"]
            screenshot_path = f"screenshots/{item.nodeid.replace('::', '_')}.png"

            try:
                page.screenshot(path=screenshot_path, full_page=True)
                print(f"\nScreenshot saved: {screenshot_path}")
            except Exception as e:
                print(f"\nFailed to capture screenshot: {e}")
